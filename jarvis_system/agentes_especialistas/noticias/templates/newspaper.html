<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ topico }} - The J.A.R.V.I.S. Chronicle</title>
  <link href="https://fonts.googleapis.com/css2?family=Chomsky&family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Lora:ital,wght@0,400;0,600;1,400&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-paper: #f4f1ea;
      --ink-black: #1a1a1a;
      --accent-red: #8a1c1c;
      --page-width: 210mm;
      --page-height: 297mm;
      --margin-top: 15mm;
      --margin-side: 18mm; 
      --margin-bottom: 12mm; 
      --footer-height: 8mm; 
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #2e2e2e;
      font-family: 'Lora', serif;
      color: var(--ink-black);
      padding: 40px;
      
      /* Renderização Otimizada */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      
      opacity: 0; 
      transition: opacity 0.3s ease;
    }

    body.ready { opacity: 1 !important; }

    .page {
      width: var(--page-width);
      height: var(--page-height);
      background-color: var(--bg-paper);
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
      margin: 0 auto 40px auto;
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      padding: var(--margin-top) var(--margin-side) var(--margin-bottom) var(--margin-side);
      border: 1px solid #d3cfc6;
    }

    .content-area { width: 100%; height: calc(100% - var(--footer-height)); overflow: hidden; display: flex; flex-direction: column; }
    
    .page-footer { 
        height: var(--footer-height); 
        width: 100%; 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        border-top: 1px solid var(--ink-black); 
        border-bottom: 1px solid var(--ink-black); 
        margin-top: auto; 
        padding-top: 2px; 
        font-family: 'Cinzel', serif; 
        font-size: 7pt; 
        letter-spacing: 1px; 
        font-weight: 700; 
        color: #444; 
    }

    #source-content { display: none; }

    .header-section { text-align: center; border-bottom: 4px double var(--ink-black); padding-bottom: 15px; margin-bottom: 25px; flex-shrink: 0; }
    .meta-header { display: flex; justify-content: space-between; font-family: sans-serif; font-size: 7pt; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid var(--ink-black); padding-bottom: 6px; margin-bottom: 12px; color: #555; }
    .main-title { font-family: 'Cinzel', serif; font-size: 46pt; font-weight: 900; letter-spacing: -1px; margin: 10px 0 5px 0; line-height: 0.9; text-transform: uppercase; text-shadow: 1px 1px 0px rgba(0,0,0,0.1); }
    .motto { font-family: 'Playfair Display', serif; font-style: italic; font-size: 11pt; margin-bottom: 15px; color: #444; }
    .info-bar { border-top: 1px solid var(--ink-black); border-bottom: 1px solid var(--ink-black); padding: 6px; font-size: 8pt; font-weight: bold; text-transform: uppercase; letter-spacing: 3px; background-color: rgba(0,0,0,0.03); }

    .headline-section { text-align: center; margin-bottom: 35px; flex-shrink: 0; }
    .headline-section h2 { font-family: 'Playfair Display', serif; font-size: 32pt; font-weight: 900; text-transform: uppercase; line-height: 1; margin-bottom: 10px; }
    .headline-section p { font-family: 'Lora', serif; font-size: 12pt; font-style: italic; color: var(--accent-red); }

    .dashboard-grid { 
        display: grid; 
        grid-template-columns: 140px 1px 1fr 1px 140px; 
        gap: 15px; 
        align-content: start; 
    }
    
    .vertical-line { background-color: #ccc; width: 1px; height: 100%; }

    .sidebar h3 { font-family: 'Cinzel', serif; font-size: 9pt; border-bottom: 2px solid var(--ink-black); margin-bottom: 12px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
    .sidebar-item { margin-bottom: 10px; border-bottom: 1px dotted #bbb; padding-bottom: 6px; font-size: 8pt; line-height: 1.3; max-height: 80px; overflow: hidden; }
    .sidebar-item strong { display: block; color: var(--accent-red); font-size: 7.5pt; text-transform: uppercase; margin-bottom: 2px; word-break: break-word; }

    .source-btn { 
      display: block; text-decoration: none; color: #333; font-weight: 600; font-family: 'Merriweather', serif; font-size: 7.5pt; transition: color 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
    }
    .source-btn:hover { color: var(--accent-red); text-decoration: underline; }
    .source-btn::after { content: " »"; color: var(--accent-red); }

    .gallery { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .gallery img { width: 100%; height: 90px; object-fit: cover; border: 1px solid #333; filter: grayscale(100%) contrast(120%) sepia(20%); display: block; }
    .caption { font-family: sans-serif; font-size: 6pt; text-transform: uppercase; margin-top: 3px; text-align: right; color: #666; }

    .summary-box { border-top: 1px solid var(--ink-black); border-bottom: 1px solid var(--ink-black); padding-bottom: 20px; padding-top: 20px; font-size: 10.5pt; text-align: justify; font-style: italic; line-height: 1.5; font-family: 'Lora', serif; } 
    
    .text-block { font-family: 'Merriweather', serif; font-size: 10.5pt; line-height: 1.65; text-align: justify; margin-bottom: 18px; color: #222; hyphens: auto; }
    .text-block h3 { font-family: 'Cinzel', serif; font-size: 14pt; font-weight: 700; color: var(--ink-black); border-bottom: 2px solid var(--accent-red); padding-bottom: 5px; margin: 30px 0 15px 0; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
    .text-block ul { list-style: none; padding: 15px 0; margin: 15px 15px; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; }
    .text-block li { margin-bottom: 6px; padding-left: 20px; position: relative; font-size: 10pt; font-style: italic; color: #444; }
    .text-block li::before { content: "❧"; position: absolute; left: 0; color: var(--accent-red); font-size: 10pt; }
    
    /* --- CORREÇÃO DA LETRA CAPITULAR --- */
    .drop-cap { 
        float: left; 
        font-family: 'Cinzel', serif; 
        font-size: 55pt; 
        line-height: 0.8; 
        padding-right: 12px; 
        padding-top: 2px; 
        color: var(--ink-black); 
        text-shadow: 2px 2px 0px rgba(0,0,0,0.1); 
        
        /* OBRIGA A SER MAIÚSCULA */
        text-transform: uppercase; 
    }

    @media print {
      body { background: none; margin: 0; padding: 0; opacity: 1 !important; }
      .page { margin: 0; box-shadow: none; border: none; background: white; break-after: page; page-break-after: always; }
      @page { size: A4; margin: 0; }
    }
  </style>
</head>
<body>

  <div id="print-container"></div>

  <div id="source-content">
    <div id="cover-content">
      <div class="header-section">
        <div class="meta-header">
          <span>Edição Extraordinária</span>
          <span>JOÃO PESSOA, PB • {{ data_hoje }}</span>
          <span>Vol. CDXX</span>
        </div>
        <h1 class="main-title">The J.A.R.V.I.S. Chronicle</h1>
        <p class="motto">"Compilando a verdade, linha por linha"</p>
        <div class="info-bar">{{ dia_semana }} &nbsp; • &nbsp; IFPB Campus JP &nbsp; • &nbsp; Briefing Executivo</div>
      </div>

      <div class="headline-section">
        <h2>{{ topico }}</h2>
        <p>Relatório de Inteligência & Análise Técnica</p>
      </div>

      <div class="dashboard-grid">
        <div class="sidebar">
          <h3>Fontes Primárias</h3>
          {% for dado in dados[:5] %}
          <div class="sidebar-item">
            <strong>{{ dado.fonte }}</strong>
            <a href="{{ dado.url | default('#') }}" target="_blank" class="source-btn" title="{{ dado.titulo }}">
              {{ dado.titulo }}
            </a>
          </div>
          {% endfor %}
          
          <h3>Ficha Técnica</h3>
          <div class="sidebar-item"><strong>Total Fontes:</strong> {{ dados|length }}</div>
          <div class="sidebar-item"><strong>Agente:</strong> {{ nome_agente | default('News-Bot v4.1') }}</div>
        </div>

        <div class="vertical-line"></div>

        <div class="center-panel">
          {% if galeria_imagens and galeria_imagens|length > 0 %}
          <div class="gallery">
            {% for item in galeria_imagens[:4] %}
            <div>
              <img src="{{ item.url }}" onerror="this.onerror=null; this.src='https://picsum.photos/400/300?grayscale';">
              <div class="caption">{{ item.titulo[:20] }}</div>
            </div>
            {% endfor %}
          </div>
          {% elif imagem_destaque %}
             <div class="gallery">
                <div style="grid-column: span 2;">
                    <img src="{{ imagem_destaque }}" onerror="this.onerror=null; this.src='https://picsum.photos/800/400?grayscale';" style="height: 200px;">
                </div>
             </div>
          {% endif %}
          
          <div class="summary-box">
            <h3 style="font-family:'Cinzel'; font-size:10pt; text-align:center; border-bottom:1px solid #000; margin-bottom:10px;">RESUMO EXECUTIVO</h3>
            {% if resumo_executivo %}
              <p>
                <span class="drop-cap">{{ resumo_executivo.strip()[0] | upper }}</span>{{ resumo_executivo.strip()[1:] }}
              </p>
            {% else %}
              <p style="text-align:center; font-style:italic; color:#666; padding:10px;">
                Aguardando dados de inteligência para processamento...
              </p>
            {% endif %}
          </div>
        </div>

        <div class="vertical-line"></div>

        <div class="sidebar">
          <h3>Sistema</h3>
          <div class="sidebar-item"><strong>Processamento</strong>Groq LPU</div>
          <div class="sidebar-item"><strong>Render</strong>Playwright Engine</div>
          <h3>Status</h3>
          <div style="border:2px solid var(--accent-red); color:var(--accent-red); text-align:center; padding:10px; font-weight:bold; font-size:9pt; margin-top:10px;">FINALIZADO</div>
        </div>
      </div>
    </div>

    <div id="article-flow">
      <div class="text-block" style="text-align:center; margin-bottom: 40px;">
         <span style="display:inline-block; border-top:1px solid #000; border-bottom:1px solid #000; padding:5px 20px; font-family:'Cinzel'; font-size:14pt; letter-spacing:2px;">ANÁLISE PROFUNDA</span>
      </div>
      <div class="llm-content">
        {{ conteudo_html | safe }}
      </div>
    </div>
  </div>

  <script>
    window.onload = function() {
      // USAMOS document.fonts.ready MAS COM TRATAMENTO DE ERRO NO PYTHON
      document.fonts.ready.then(function() {
          try {
              const container = document.getElementById('print-container');
              const sourceCover = document.getElementById('cover-content');
              const sourceArticle = document.querySelector('.llm-content');
              
              let pageCount = 1;
              const docDate = "{{ data_hoje }}";

              function createPage() {
                const page = document.createElement('div');
                page.className = 'page';
                const contentArea = document.createElement('div');
                contentArea.className = 'content-area';
                page.appendChild(contentArea);
                const footer = document.createElement('div');
                footer.className = 'page-footer';
                footer.innerHTML = `<span>J.A.R.V.I.S. SYSTEM</span><span>${docDate}</span><span>PÁGINA ${pageCount}</span>`;
                page.appendChild(footer);
                container.appendChild(page);
                pageCount++;
                return contentArea;
              }

              // 1. CAPA
              const page1Area = createPage();
              page1Area.innerHTML = sourceCover.innerHTML;

              // 2. MIOLO
              let currentPageArea = createPage();
              const MAX_HEIGHT_PX = currentPageArea.offsetHeight;
              const SAFE_BUFFER = 60; 
              const SAFE_LIMIT_PX = MAX_HEIGHT_PX - SAFE_BUFFER;
              let currentPixelHeight = 0;

              if (sourceArticle) {
                  const headerTitle = document.querySelector('#article-flow .text-block').cloneNode(true);
                  currentPageArea.appendChild(headerTitle);
                  currentPixelHeight += headerTitle.offsetHeight;

                  const elements = Array.from(sourceArticle.children); 

                  elements.forEach(el => {
                    const clone = el.cloneNode(true);
                    if(!clone.classList.contains('text-block') && clone.tagName !== 'H3') {
                        clone.classList.add('text-block');
                    }
                    
                    clone.style.visibility = 'hidden'; 
                    currentPageArea.appendChild(clone);
                    
                    const elHeight = clone.offsetHeight;
                    const style = window.getComputedStyle(clone);
                    const margin = parseInt(style.marginTop) + parseInt(style.marginBottom);
                    const totalHeight = elHeight + margin;

                    if ((currentPixelHeight + totalHeight) > SAFE_LIMIT_PX) {
                      currentPageArea.removeChild(clone);
                      currentPageArea = createPage();
                      currentPixelHeight = 0;
                      clone.style.visibility = 'visible';
                      currentPageArea.appendChild(clone);
                      currentPixelHeight += totalHeight;
                    } else {
                      clone.style.visibility = 'visible';
                      currentPixelHeight += totalHeight;
                    }
                  });
              }
              
              document.getElementById('source-content').innerHTML = '';
              document.body.classList.add('ready');

          } catch (error) {
              console.error("Erro JS:", error);
              document.body.classList.add('ready');
          }
      });
    };
  </script>

</body>
</html>